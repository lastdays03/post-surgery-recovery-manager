# LLM 사용 고도화 마스터 플랜 (Advanced LLM Sophistication Plan)

현재 프로젝트의 AI 기능을 단순 정보 제공 수준에서 **개인 맞춤형 임상 보조 도구** 수준으로 격상시키기 위한 고도화 계획입니다.

## 🎯 목표 (Objectives)
1. **정확도 (Accuracy)**: 하이브리드 검색을 통해 의학 전문 용어 및 특정 수술 명칭에 대한 검색 정확도 개선.
2. **개인화 (Context-Awareness)**: 사용자의 건강 데이터(통증 기록, 식단 이행률) 및 상세 수술 정보를 LLM이 직접 파악하여 개인화된 피드백 제공.
3. **사용자 경험 (UX)**: 경직된 선택형 온보딩에서 탈피하여 대화를 통한 자연스러운 정보 수집 및 프로파일링 구현.
4. **안전성 (Clinical Safety)**: 생성된 답변이 사전에 정의된 임상 가이드라인과 충돌하지 않는지 자동 검증.

## 🏗 아키텍처 결정 (Architecture Decisions)

### 1. Conversational Profiler (Onboarding)
- **이유**: 기존 5종 수술 외의 다양한 수술 케이스 및 환자별 특수 상황(의사 소견 등)을 반영하기 위해 대화형 인터페이스 도입. LLM이 대화에서 핵심 정보를 추출(Structured Extraction)하여 사용자 프로필을 자동 구성.

### 2. Hybrid RAG (Vector + Keyword)
- **이유**: 단순 벡터 검색은 의학 용어나 숫자(D+7 등)의 의미적 유사성만 파악하여 정밀도가 떨어질 수 있음. Supabase의 Full Text Search(FTS)를 결합하여 전문 용어 매칭을 보완.

### 3. Agentic Tool Use (Function Calling)
- **이유**: 현재 LLM은 사용자의 실시간 상태를 알지 못함. `get_user_stats`, `get_recovery_protocol`과 같은 도구를 정의하여 LLM이 필요할 때 직접 데이터를 쿼리하게 함.

### 4. Verification Layer (Twin-Model Check)
- **이유**: 의료 보조 도구로서 오답(Hallucination)은 치명적임. 답변 생성 후, 다른 검증용 프롬프트가 가이드라인 위반 여부를 최종 체크하는 레이어 추가.

## 📅 단계별 구현 계획 (Phase Breakdown)

### Phase 0: 대화형 AI 온보딩 (Conversational AI Onboarding)
- **목표**: 자유로운 대화를 통해 수술 정보 및 개인 건강 상태를 정교하게 수집.
- **작업**:
  - [ ] 대화형 온보딩 전용 `OnboardingChat` 컴포넌트 구현.
  - [ ] LLM 프롬프트 설계: 수술명, 방법, 의사 주의사항, 기저질환 등을 전문적으로 질문하고 수집.
  - [ ] **데이터 추출**: 대화 내용에서 `UserProfile` 및 `HealthStatus` 스키마에 맞는 데이터를 JSON으로 추출하는 로직 구현.
  - [ ] 추출된 데이터를 기반으로 하는 맞춤형 회복 스케줄 자동 생성 로직 연동.
- **성공 지표**: 사용자가 느끼는 입력 피로도 감소 및 기존 고정형 대비 수집 데이터의 상세도 향상.

### Phase 1: 하이브리드 검색 및 리랭킹 (Hybrid RAG & Re-ranking)
- **목표**: 지식 베이스 검색 품질 40% 이상 향상.
- **작업**:
  - [ ] Supabase `knowledge_base` 테이블에 `fts` 컬럼 및 GIN 인덱스 추가.
  - [ ] `match_documents` 함수를 수정한 `hybrid_search` RPC 구현.
  - [ ] `lib/ai/rag-search.ts`에서 하이브리드 가중치 기반 결과 통합 로직 적용.
- **성공 지표**: 전문 의학 용어 포함 쿼리에 대한 검색 결과 정확도 개선.

### Phase 2: 에이전트 도구 사용 (Agentic Function Calling)
- **목표**: 사용자 건강 통계 데이터를 반영한 유동적인 답변 제공.
- **작업**:
  - [ ] OpenAI/Gemini의 Function Calling 사양에 따른 도구 정의 (Pain Log 조회, 식단 기록 조회).
  - [ ] `lib/ai/chat-assistant.ts`를 도구 실행 루프가 포함된 구조로 리팩토링.
  - [ ] 도구 실행 결과(샌드박스화된 데이터)를 LLM 프롬프트에 동적으로 추가.
- **성공 지표**: "내 지난주 통증 기록이 어땠어?"와 같은 질문에 정확히 답변.

### Phase 3: 지능형 및 대화형 식단 고도화 (Intelligent & Conversational Meal System)
- **목표**: 정적 제안을 넘어 사용자와의 대화를 통해 식단을 실시간으로 수정하고 최적화.
- **작업**:
  - [ ] `Meal` 인터페이스를 준수하는 구조화된 출력을 생성하는 전용 프롬프트 엔지니어링.
  - [ ] **대화형 수정 루프**: "계란 빼줘", "좀 더 부드러운 걸로 바꿔줘" 등 사용자의 피드백을 반영하여 식단을 재생성하는 컨텍스트 관리 로직.
  - [ ] 입력 데이터에 사용자 선호(좋아하는 음식), 기피 재료, 보유 식재료 포함 기능 추가.
  - [ ] 수술별 회복 단계(Liquid -> Soft -> Regular)와 임상 가이드라인을 강제 준수하는 로직 결합.
- **성공 지표**: 사용자의 수정 요청이 3회 이내에 임상 가이드를 준수하며 완벽히 반영됨.

### Phase 4: 임상 안전 가드레일 및 검증 고도화 (Clinical Safety v2)
- **목표**: 잘못된 의학적 조언 생성 가능성 1% 미만으로 억제.
- **작업**:
  - [ ] `lib/ai/safety-guardrails.ts`에 사후 검증(Post-inference) 로직 추가.
  - [ ] 위험 키워드(응급 상황 등) 감지 시 자동으로 응급 전화 또는 병원 방문 유도 메시지 강제 주입.
  - [ ] LLM 답변 내 수술 후 절대 금기 사항이 포함되었는지 체크하는 '검증 모델' 연동.
- **성공 지표**: 금기 사항에 대한 오답 발생 시 즉각적인 차단 및 경고 표시.

## ⚠️ 리스크 평가 및 완화 (Risk Assessment)

| 리스크 | 발생 가능성 | 영향도 | 완화 전략 |
| :--- | :---: | :---: | :--- |
| API 비용 증가 | 높음 | 중간 | 캐싱 및 도구 사용 횟수 제한, 모델 토큰 모니터링 강화 |
| 지연 시간(Latency) 증가 | 중간 | 높음 | 스트리밍 응답 우선 적용, 비동기 검증 로직 최적화 |
| 잘못된 데이터 추출 (Extraction) | 중간 | 높음 | 추출된 데이터를 사용자에게 최종 확인받는 '확인 단계' UI 필수 도입 |
| 잘못된 데이터 조회 (Privacy) | 낮음 | 매우 높음 | 도구 실행 시 사용자 권한(RBAC) 엄격히 검증 |

## 🔄 롤백 전략 (Rollback Strategy)
- 기능별 Feature Flag를 도입하여 문제 발생 시 `lib/ai/llm-service.ts`에서 기존 방식(Legacy Chat)으로 즉시 전환 가능하도록 설계.
- Supabase 마이그레이션 실패 시 `down` 스크립트 준비.

---
**작성일**: 2026-01-25
**상태**: 검토 대기 중 (Waiting for Review)
